# 版本说明

本仓库版本为2.15.1。安装问题参考README.md以及网站（https://mmdetection.readthedocs.io/zh_CN/latest/）  
若要详细了解MMDetection的整体结构和各项内容，也可于上述网站进行教程学习。   

# 目录
- [准备环境](#环境配置) 
- [数据集](#数据集结构)   
- [运行](#运行)  
	- [训练](#训练)  
	- [测试](#测试)  
- [配置文件名称风格](#配置文件命名)  
- [修改数据集](#数据集)  
- [参数修改](#参数)   
- [可视化部分](#运行)
	- [锚图](#锚图)
    - [pr曲线](#pr曲线)
    - [热图](#热图)

## 研究点

研究点一：configs/1/baseline/atss_v6_myfpnv12_1_vhrvoc_topk10.py
研究点二：configs/2/ours_2_3_verify_3/vhr/atss_fnpndrsncv3_555_atssassign_vhr_cosv3giou_2.py
baseline：RESNET-50-ATSS

## 准备环境
```
    配环境的时候保持 cuda， torch，mmdetection（主要看mmcv版本）一致。  
    
    此MMDetection为2.15.1版本，对应mmcv-full版本：  >= 1.3.8,   < 1.4.0 ,  

    ###若cuda及torch版本过新，会没有旧版本的mmcv-full  

        eg:  
           python：3.7  
           cuda：10.2  
           torch：1.9.0  
           mmcv-full：1.3.10  
           建立环境可顺利运行此版本。  
           
        其中mmcv-full-1.3.10可在 https://download.openmmlab.com/mmcv/dist/cu102/torch1.9.0/index.html 中下载  
        命令如下：  
``` 
        conda create -n mmdetection python=3.7 -y
        conda activate mmdetection
        conda install pytorch==1.9.0 torchvision==0.10.0 torchaudio==0.9.0 cudatoolkit=10.2 -c pytorch
        pip install mmcv_full-1.3.10-cp37-cp37m-manylinux1_x86_64.whl
        pip install -r requirements/build.txt
        pip install -v -e .
```
    至此，完成环境准备工作  
    验证：
   测试一张图片：
    python demo/image_demo.py ${IMAGE_FILE} ${CONFIG_FILE} ${CHECKPOINT_FILE} [--device ${GPU_ID}] [--score-thr ${SCORE_THR}]
        eg：
            python demo/image_demo.py demo/demo.jpg configs/faster_rcnn_r50_fpn_1x_coco.py \
            checkpoints/ faster_rcnn_r50_fpn_1x_20181010-3d1b3351.pth --device cpu
    若能生成一张锚图，证明环境可用
```
## 数据集
```
├── data
│   ├── VHR_voc
│   │   ├── Annotations
│   │   │   ├── 001.xml
│   │   │   ├── 002.xml
│   │   │   └── ...
│   │   ├── ImageSets
│   │   │   ├── Main
│   │   │   │   ├── train.txt
│   │   │   │   └── test.txt
│   │   └──JPEGImages
│   │   │   ├── 001.jpg
│   │   │   ├── 002.jpg
│   │   │   └── ...
│   ├── VHR_coco
│   │   ├── annotations
│   │   │   ├── train.json
│   │   │   └── test.json
│   │   ├── train
│   │   │   ├── 001.jpg
│   │   │   ├── 001.jpg
│   │   │   ├── ...
│   │   ├── test
│   │   │   ├── 001.xml
│   │   │   ├── 001.xml
│   │   │   ├── 001.xml
│   │   │   ├── crawl
│   │   │   ├── creep
│   │   │   ├── ...
│   │   ├── test
│   │   │   ├── box
│   │   │   │   ├── aaa.jpg 
│   │   │   │   ├── bbb.png
│   │   │   │   └── ...
│   │   │   ├── crawl
│   │   │   ├── creep
│   │   │   ├── ...
├── MMDetection
```
## 运行
### 训练
    单机单卡： python tools/train.py ${CONFIG_FILE} [optional arguments]

    例：
```
python tools/train.py configs/1/baseline/atss_v6_myfpnv12_1_vhrvoc_topk10.py
```   
    单机多卡： ./tools/dist_train.sh ${CONFIG_FILE} ${GPU_NUM} [optional arguments] 
            （./tools/dist_train.sh configs/mask_rcnn/mask_rcnn_r50_fpn_1x_coco.py 2）在2张gpu训练

### 测试
    # single-gpu testing    [说明](mmdetection/docs/1_exist_data_model.md)
    python tools/test.py ${CONFIG_FILE} ${CHECKPOINT_FILE} [--out ${RESULT_FILE}] [--eval ${EVAL_METRICS}] [--show]
    例：
```    
    python tools/test.py configs/1/baseline/atss_v6_myfpnv12_1_vhrvoc_topk10.py work_dirs/atss_v6_myfpnv12_1_vhrvoc_topk10/epoch_1.pth
```
    # multi-gpu testing
    ./tools/dist_test.sh ${CONFIG_FILE} ${CHECKPOINT_FILE} ${GPU_NUM} [--out ${RESULT_FILE}] [--eval ${EVAL_METRICS}]

## 配置文件名称风格
```
{model}_[model setting]_{backbone}_{neck}_[norm setting]_[misc]_[gpu x batch_per_gpu]_{schedule}_{dataset}
```
```
{xxx} 是被要求的文件 [yyy] 是可选的。

    {model}： 模型种类，例如 faster_rcnn, mask_rcnn 等。

    [model setting]： 特定的模型，例如 htc 中的without_semantic， reppoints 中的 moment 等。

    {backbone}： 主干网络种类例如 r50 (ResNet-50), x101 (ResNeXt-101) 等。

    {neck}： Neck 模型的种类包括 fpn, pafpn, nasfpn, c4 等。

    [norm_setting]： 默认使用 bn (Batch Normalization)，其他指定可以有 gn (Group Normalization)， syncbn (Synchronized Batch Normalization) 等。 gn-head/gn-neck 表示 GN 仅应用于网络的 Head 或 Neck， gn-all 表示 GN 用于整个模型， 例如主干网络、Neck 和 Head。

    [misc]： 模型中各式各样的设置/插件，例如 dconv、 gcb、 attention、albu、 mstrain 等。

    [gpu x batch_per_gpu]：GPU 数量和每个 GPU 的样本数，默认使用 8x2。

    {schedule}： 训练方案，选项是 1x、 2x、 20e 等。1x 和 2x 分别代表 12 epoch 和 24 epoch，20e 在级联模型中使用，表示 20 epoch。对于 1x/2x，初始学习率在第 8/16 和第 11/22 epoch 衰减 10 倍；对于 20e ，初始学习率在第 16 和第 19 epoch 衰减 10 倍。

    {dataset}：数据集，例如 coco、 cityscapes、 voc_0712、 wider_face 等。
```
## 修改数据集
```
若设置自己的数据集，建议准备COCO格式的数据集。以SSDD数据集为例子，4个改动地方：    
    1. 新建 /config/datasets/ssdd_detection.py ，copy coco_detection.py, 改动 data_root, dataset_type,   img_norm_cfg, ann_file, img_prefix
    2. 新建 /mmdet/datasets/ssdd.py, copy coco.py, 改动 CLASSES  
    3. 向 /mmdet/core/evaluation/class_names.py 添加数据集对应的分类名称  
    4. 向 /mmdet/datasets/__init__.py 导入对应数据集类，并添加到list中。  
```
```
若要修改数据集根目录，可在config文件中的data_root = 'data/VHR_voc/' 中进行修改。  
若config文件中没有data_root，可在config文件中的_base_=[    ]中指定的detection.py文件中找到data_root进行修改  
例：
某一config文件中  
    base_ = [  
    '../../../_base_/datasets/vhrvoc_detection.py',  
    '../../../_base_/schedules/schedule_1x.py', '../../../_base_/default_runtime.py'  
]  
可在configs/_base_/datasets/vhrvoc_detection.py'中修改data_root  
```

## 参数修改
注：MMDetection中，要在对应的config文件中对参数进行修改。如dataset_root,max_epoch等.
部分参数的修改要在config文件中调用的configs/_base_/datasets/xxx _detection.py中，如dataset_root,batch_size等.
### 学习率
```  
    学习率：对应配置文件的optimizer中  
        调整方法：默认：    8gpu*2img/gpu:0.02  
                线性原则： 1gpu*ximg/gpu：0.002/8/2*x  
                有：      1gpu*8img/gpu:0.01  
                有：      1gpu*16img/gpu:0.02  
                         
```
### workflow
```
    
    workflow = [('train', 1)]，： train workflow，也就是迭代训练  
    workflow = [('train', n),('val', 1)]：先进行 n 个 epoch 的训练，后再进行1个 epoch 的验证，然后循环往复,  
    workflow = [('val', 1),('train', n)] 表示先进行验证，然后才开始训练       
```
### 输出特征图索引
```
    out_indices = (0,1,2,3):表示输出的特征图索引为（0，1，2，3）  
    ResNet的骨架范式：stem + n stage + cls head，实际为 stem -> 4个stage ->cls head  
    stem的输出stride为4， 4个stage的输出stride为 4， 8， 16， 32， 这4个输出就对应out_indices的索引  
    eg：想要输出stride=4的特征图， out_indices = (0,)  
        ...       =4和16  .... ，  out_indices = (0, 2)   
```
### 权重固定
frozen_stages:
```
    frozen_stages=-1，表示全部可学习  
    frozen_stage=0，表示stem权重固定  
    frozen_stages=1，表示 stem 和第一个 stage 权重固定  
    frozen_stages=2，表示 stem 和前两个 stage 权重固定  
    ...
    (注意：若想重写backbone类，参考ResNet中train函数。防止运行的时候算法重新进入train模式导致BN没有固定住)  
```

### norm_cfg ， norm_eval
```
    norm_cfg ， norm_eval:  
    norm_cfg = dict(type='BN',requires_grad=True),表示采用的归一化算子，type为BN或GN，requires_grads 表示算子是否需要梯度，是否更新  
    norm_eval：用于控制整个骨架网络的归一化算子是否要变成eval模式   
```
### 分析loss/mAP
分析loss/mAP:  
注：  
    首次使用：pip install seaborn  
    需给定 training log.json file  
```
python tools/analyze_logs.py plot_curve [--keys ${KEYS}] [--title ${TITLE}] [--legend ${LEGEND}] [--backend ${BACKEND}] [--style ${STYLE}] [--out ${OUT_FILE}]  
```
eg：2.1 画出某次运行时的classification loss：  
    python tools/analyze_logs.py plot_curve log.json --keys loss_cls --legend loss_cls  
    2.2 画出... 的... 和regression loss，并保存到pdf：  
    python tools/analyze_logs.py plot_curve log.json --keys loss_cls loss_bbox --out losses.pdf  
    2.3 比较两次运行在同一张图片中的bbox mAP：  
    python tools/analyze_logs.py plot_curve log1.json log2.json --keys bbox_mAP --legend run1 run2  
    2.4 计算平均训练速度：  
    python tools/analyze_logs.py cal_train_time log.json [--include-outliers]  


### 计算FLOPs和Params
```
    python tools/get_flops.py ${CONFIG_FILE} [--shape ${INPUT_SHAPE}]
```
### 发布模型
```
 python tools/publish_model.py ${INPUT_FILENAME} ${OUTPUT_FILENAME}
```
```
eg：python tools/publish_model.py work_dirs/faster_rcnn/latest.pth faster_rcnn_r50_fpn_1x_20190801.pth
```

## 可视化部分
 ### 锚图
```
  python tools/test.py  {config} {weight.pth} --show-dir {output path}
```
```
  例:python tools/test.py configs/1/baseline/atss_v6_myfpnv12_1_vhrvoc_topk10.py \work_dirs/atss_v6_myfpnv12_1_vhrvoc_topk10/epoch_52.pth --show-dir
```
 ### pr曲线

```
生成pkl文件：  
  python tools/test.py {config} {weight.pth} --out {file_name.pkl}
```
eg：python tools/test.py configs/1/baseline/atss_v6_myfpnv12_1_vhrvoc_topk10.py work_dirs/atss_v6_myfpnv12_1_vhrvoc_topk10/latest.pth --out last.pkl
```
  若要对比多个算法，需对每个算法执行以上命令，生成不同的pkl文件  
  修改tools/multi_model_pr.py中各pkl文件路径;修改mmdet/core/evaluation/mean_ap.py的pr曲线保存路径  
  运行python tools/multi_model_pr.py即可  
```
```
  若要对单个算法的不同类进行对比  
  修改tools/analysis_tools/single_pr.py中的的pkl路径和配置文件路径，同样可在mmdet/core/evaluation/mean_ap.py修改保存的pr曲线的路径  
  运行python tools/analysis_tools/single_pr.py即可
```
 ### 热图
 #### 方式一
 利用demo/heat_visual.py产生热图
 将mmdet/models/detectors/single_satge.py中,aug_test函数的return值改为(feats,);simple_test函数的return值改为(feat,)使其返回特征图
 将demo/heat_visual.py中
            41行改为        result= inference_detector(model, img)
            46和62行改为    for featuremap in result:
        
运行命令 python demo/heatmap_visual.py {figure} {config} {weight}
例：python demo/heatmap_visual.py data/VHR_voc/JPEGImages/121.jpg work_dirs/atss_v6_myfpnv12_1_vhrvoc_topk10/atss_v6_myfpnv12_1_vhrvoc_topk10.py work_dirs/atss_v6_myfpnv12_1_vhrvoc_topk10/latest.pth

#### 方式二
生成neck某层的热图：demo/heatmap_visual.py; 批量生成：featmap.sh
生成FPN或backbone的热图：tools/heatmap_visual.py,且需修改代码中的config和checkpoint，除此之外，生成FPN或backbone的热图时，要修改inference_detector函数的返回值，使其返回值与FPN或backbone对应。
生成某一层的热图：tools/feature_visualization.py; 批量生成：image_demo.sh
如只想生成热图，而不输出测试图片，注释掉python demo/image_demo.py 相应语句。

要生成哪一层的热图，在这层后加一行调用生成热图的命令即可
```
eg:使用feature_visualization.py
    对于configs/1/baseline/atss_v6_myfpnv12_1_vhrvoc_topk10.py，其backbone使用resnet50,neck使用了MyFPNv12_1.
    若要在其neck的某一层生成热图，则在mmdet/models/necks/myfpnv12_1.py中想要生成热图的某一层下添加以下代码：
    ```
    from tools.feature_visualization import draw_feature_map
    draw_feature_map(out)
    ```
   其中，out对应本层的输出。
   之后运行测试即可
   ```
   python tools/test.py configs/1/baseline/atss_v6_myfpnv12_1_vhrvoc_topk10.py work_dirs/atss_v6_myfpnv12_1_vhrvoc_topk10/latest.pth --show
   ```
```
```
eg：使用demo/heatmap_visual.py
    对于configs/2/ours_2_3_verify_3/vhr/atss_fnpndrsncv3_555_atssassign_vhr_cosv3giou_2.py，在其neck某一层输出热图，
    在mmdet/models/necks/fpn_drsncv3.py中的某一层添加一下代码：
```
    from demo.heatmap_visual import draw_single_map
    draw_single_map(before, name='b-before')
```
其中，before对应本层的输出
```
之后运行测试即可
```
python tools/test.py work_dirs/atss_fnpndrsncv3_555_atssassign_vhr_cosv3giou_2/atss_fnpndrsncv3_555_atssassign_vhr_cosv3giou_2.py work_dirs/atss_fnpndrsncv3_555_atssassign_vhr_cosv3giou_2/epoch_50.pth --show
```
